#!/usr/bin/env bash
#MISE description="Bump version in all paired files for a concept"
#USAGE arg "<concept>" help="Concept name (concepts, changelog, maintain-docs, modify, review, verify-tests)"
#USAGE arg "<bump>" help="Version bump type" {
#USAGE   choices "patch" "minor" "major"
#USAGE }

set -euo pipefail

CONCEPT="${usage_concept?}"
BUMP_TYPE="${usage_bump?}"

declare -A SKILL_DIRS=(
  ["concepts"]="openspec-concepts"
  ["changelog"]="openspec-generate-changelog"
  ["maintain-docs"]="openspec-maintain-ai-docs"
  ["modify"]="openspec-modify-artifacts"
  ["review"]="openspec-review-artifacts"
  ["verify-tests"]="openspec-review-test-compliance"
)

if [[ -z "${SKILL_DIRS[$CONCEPT]:-}" ]]; then
  echo "Error: Unknown concept: $CONCEPT"
  echo "Valid concepts: ${!SKILL_DIRS[*]}"
  exit 1
fi

SKILL_DIR="${SKILL_DIRS[$CONCEPT]}"

FILES=(
  "resources/claude/skills/${SKILL_DIR}/SKILL.md"
  "resources/opencode/skills/${SKILL_DIR}/SKILL.md"
  "resources/claude/commands/opsx/${CONCEPT}.md"
  "resources/opencode/command/opsx-${CONCEPT}.md"
)

FIRST_FILE="${FILES[0]}"
if [[ ! -f "$FIRST_FILE" ]]; then
  echo "Error: File not found: $FIRST_FILE"
  exit 1
fi

CURRENT_VERSION=$(grep -A2 "^metadata:" "$FIRST_FILE" | grep "version:" | head -1 | cut -d'"' -f2)

if [[ -z "$CURRENT_VERSION" ]]; then
  echo "Error: No version found in metadata block"
  exit 1
fi

IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

case "$BUMP_TYPE" in
  patch)
    NEW_PATCH=$((PATCH + 1))
    NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
    ;;
  minor)
    NEW_MINOR=$((MINOR + 1))
    NEW_VERSION="${MAJOR}.${NEW_MINOR}.0"
    ;;
  major)
    NEW_MAJOR=$((MAJOR + 1))
    NEW_VERSION="${NEW_MAJOR}.0.0"
    ;;
esac

echo "Bumping: $CURRENT_VERSION → $NEW_VERSION"
echo ""

UPDATED=0
for file in "${FILES[@]}"; do
  if [[ -f "$file" ]]; then
    sed -i "s/^\(  version: \)\".*\"/\1\"$NEW_VERSION\"/" "$file"
    echo "✓ $file"
    ((UPDATED++))
  else
    echo "⊘ $file (not found)"
  fi
done

echo ""
echo "Updated $UPDATED files to $NEW_VERSION"
