#!/usr/bin/env bash
#MISE description="Bump version in a SKILL.md file"
#USAGE arg "<file>" help="Path to SKILL.md file"
#USAGE arg "<bump>" help="Version bump type" {
#USAGE   choices "patch" "minor" "major"
#USAGE }

set -euo pipefail

FILE="${usage_file?}"
BUMP_TYPE="${usage_bump?}"

if [[ ! -f "$FILE" ]]; then
  echo "Error: File not found: $FILE"
  exit 1
fi

CURRENT_VERSION=$(grep -A2 "^metadata:" "$FILE" | grep "version:" | head -1 | cut -d'"' -f2)

if [[ -z "$CURRENT_VERSION" ]]; then
  echo "Error: No version found in metadata block"
  exit 1
fi

IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

case "$BUMP_TYPE" in
  patch)
    NEW_PATCH=$((PATCH + 1))
    NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
    ;;
  minor)
    NEW_MINOR=$((MINOR + 1))
    NEW_VERSION="${MAJOR}.${NEW_MINOR}.0"
    ;;
  major)
    NEW_MAJOR=$((MAJOR + 1))
    NEW_VERSION="${NEW_MAJOR}.0.0"
    ;;
esac

echo "Bumping: $CURRENT_VERSION → $NEW_VERSION in $FILE"

sed -i "s/^\(  version: \)\".*\"/\1\"$NEW_VERSION\"/" "$FILE"

echo "✓ Updated to $NEW_VERSION"
