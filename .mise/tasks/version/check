#!/usr/bin/env bash
#MISE description="Verify SKILL.md files have version bump when modified"

set -euo pipefail

HAS_ERROR=0

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR -- 'resources/**/SKILL.md')

if [[ -z "$STAGED_FILES" ]]; then
  exit 0
fi

for file in $STAGED_FILES; do
  CURRENT_VERSION=$(git show ":$file" 2>/dev/null | grep -A2 "^metadata:" | grep "version:" | head -1 | cut -d'"' -f2 || echo "")
  
  if git show "HEAD:$file" &>/dev/null; then
    PREVIOUS_VERSION=$(git show "HEAD:$file" | grep -A2 "^metadata:" | grep "version:" | head -1 | cut -d'"' -f2 || echo "")
    
    if [[ "$CURRENT_VERSION" == "$PREVIOUS_VERSION" ]]; then
      echo "Error: $file modified but version not bumped (still $CURRENT_VERSION)"
      HAS_ERROR=1
    fi
  fi
done

if [[ $HAS_ERROR -eq 1 ]]; then
  echo ""
  echo "Bump the version in metadata.version field before committing."
  echo "Use: mise run version:update <file> <patch|minor|major>"
  exit 1
fi

exit 0
