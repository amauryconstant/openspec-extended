#!/bin/bash
# OpenSpec-extended - Simplified installer for OpenSpec skills
# Usage: openspecx <install|update> <tool>

set -euo pipefail

readonly FALLBACK_VERSION="0.1.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly SCRIPT_DIR
readonly RESOURCES_DIR="$SCRIPT_DIR/../resources"

readonly COLOR_GREEN='\033[0;32m'
readonly COLOR_RED='\033[0;31m'
readonly COLOR_RESET='\033[0m'

declare -A TOOL_DIRS=(
    ["claude"]=".claude/skills"
    ["opencode"]=".opencode/skills"
)

log_success() {
    echo -e "${COLOR_GREEN}✓${COLOR_RESET} $*"
}

log_error() {
    echo -e "${COLOR_RED}✗${COLOR_RESET} $*" >&2
}

get_script_version() {
    local version
    version=$(git -C "$SCRIPT_DIR" describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "")
    if [[ -n "$version" ]]; then
        echo "$version"
    else
        echo "$FALLBACK_VERSION"
    fi
}

inject_generated_by() {
    local file="$1"
    local version="$2"
    
    if [[ ! -f "$file" ]]; then
        return
    fi
    
    local content
    content=$(cat "$file")
    local new_content
    
    if echo "$content" | grep -q "^metadata:"; then
        if echo "$content" | grep -q "^  generatedBy:"; then
            new_content=$(echo "$content" | sed "s/^  generatedBy: \".*\"/  generatedBy: \"$version\"/")
        else
            new_content=$(echo "$content" | sed "/^metadata:/a\\  generatedBy: \"$version\"")
        fi
    else
        if echo "$content" | grep -q "^---"; then
            new_content=$(echo "$content" | sed "/^---$/a\\metadata:\\n  generatedBy: \"$version\"")
        else
            new_content="$content"
        fi
    fi
    
    echo "$new_content" > "$file"
}

copy_and_process_skills() {
    local source_dir="$1"
    local target_dir="$2"
    local version="$3"
    local force="$4"
    
    local processed_count=0
    local skipped_count=0
    
    while IFS= read -r -d '' skill_dir; do
        local skill_name
        skill_name=$(basename "$skill_dir")
        local target_skill_dir="$target_dir/$skill_name"
        
        if [[ "$force" == "true" ]]; then
            cp -r "$skill_dir" "$target_dir/"
            
            local skill_file="$target_skill_dir/SKILL.md"
            if [[ -f "$skill_file" ]]; then
                inject_generated_by "$skill_file" "$version"
            fi
            
            processed_count=$((processed_count + 1))
        else
            if [[ -d "$target_skill_dir" ]]; then
                skipped_count=$((skipped_count + 1))
            else
                cp -r "$skill_dir" "$target_dir/"
                
                local skill_file="$target_skill_dir/SKILL.md"
                if [[ -f "$skill_file" ]]; then
                    inject_generated_by "$skill_file" "$version"
                fi
                
                processed_count=$((processed_count + 1))
            fi
        fi
    done < <(find "$source_dir" -mindepth 1 -maxdepth 1 -type d -print0)
    
    echo "$processed_count:$skipped_count"
}

show_usage() {
    log_error "Usage: openspecx <command> <tool>"
    echo
    echo "Commands:"
    echo "  install <tool>  Add missing skills (skip existing)"
    echo "  update <tool>   Force update all skills (overwrite existing)"
    echo
    echo "Available tools: claude, opencode"
}

if [[ $# -lt 2 ]]; then
    show_usage
    exit 1
fi

COMMAND="$1"
TOOL="$2"

if [[ "$COMMAND" != "install" && "$COMMAND" != "update" ]]; then
    log_error "Unknown command: $COMMAND"
    echo
    echo "Available commands: install, update"
    echo
    show_usage
    exit 1
fi

if [[ -z "${TOOL_DIRS[$TOOL]:-}" ]]; then
    log_error "Unknown tool: $TOOL"
    echo "  Available tools: claude, opencode"
    exit 1
fi

SCRIPT_VERSION=$(get_script_version)
TARGET_DIR="${TOOL_DIRS[$TOOL]}"
FULL_PATH="$(pwd)/$TARGET_DIR"

mkdir -p "$FULL_PATH"

if [[ -d "$RESOURCES_DIR/$TOOL/skills" ]]; then
    if [[ "$COMMAND" == "update" ]]; then
        RESULT=$(copy_and_process_skills "$RESOURCES_DIR/$TOOL/skills" "$FULL_PATH" "$SCRIPT_VERSION" "true")
        UPDATED_COUNT="${RESULT%%:*}"
        
        if [[ $UPDATED_COUNT -gt 0 ]]; then
            log_success "Updated $UPDATED_COUNT skill(s) in $TOOL (v$SCRIPT_VERSION)"
            echo "  Target: $TARGET_DIR"
        else
            echo "No skills found in resources/$TOOL/skills/"
        fi
    else
        RESULT=$(copy_and_process_skills "$RESOURCES_DIR/$TOOL/skills" "$FULL_PATH" "$SCRIPT_VERSION" "false")
        INSTALLED_COUNT="${RESULT%%:*}"
        SKIPPED_COUNT="${RESULT##*:}"
        
        if [[ $INSTALLED_COUNT -gt 0 ]]; then
            log_success "Installed $INSTALLED_COUNT skill(s) to $TOOL (v$SCRIPT_VERSION)"
            echo "  Target: $TARGET_DIR"
        fi
        
        if [[ $SKIPPED_COUNT -gt 0 ]]; then
            echo "  Skipped $SKIPPED_COUNT existing skill(s)"
        fi
        
        if [[ $INSTALLED_COUNT -eq 0 && $SKIPPED_COUNT -eq 0 ]]; then
            echo "No skills found in resources/$TOOL/skills/"
        fi
    fi
else
    echo "resources/$TOOL/skills/ directory not found"
fi

COMMANDS_DIR="$(pwd)/$(dirname "$TARGET_DIR")/command"
if [[ -d "$RESOURCES_DIR/$TOOL/command" ]]; then
    mkdir -p "$COMMANDS_DIR"
    COMMAND_COUNT=$(find "$RESOURCES_DIR/$TOOL/command" -mindepth 1 -maxdepth 1 -type f 2>/dev/null | wc -l)
    
    if [[ $COMMAND_COUNT -gt 0 ]]; then
        cp -r "$RESOURCES_DIR/$TOOL/command"/* "$COMMANDS_DIR/"
        log_success "Copied $COMMAND_COUNT command(s) to $TOOL"
        echo "  Target: $(basename "$COMMANDS_DIR")/"
    fi
fi
